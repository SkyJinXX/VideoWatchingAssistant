<!DOCTYPE html>
<html>
<head>
    <title>加密格式调试</title>
    <script src="chrome-extension/src/utils/crypto-js.min.js"></script>
</head>
<body>
    <h1>字幕API加密格式调试</h1>
    
    <div>
        <h3>测试视频ID: g_cU-DrUPGI</h3>
        <button onclick="testEncryption()">测试加密</button>
        <button onclick="testWorkingFormat()">解析工作的格式</button>
    </div>
    
    <div id="results"></div>

    <script>
        const SECRET_KEY = "zthxw34cdp6wfyxmpad38v52t3hsz6c5";
        
        // 完全照抄Tampermonkey脚本的formatJson
        const formatJson = {
            stringify: function (crp) {
                let result = {
                    ct: crp.ciphertext.toString(CryptoJS.enc.Base64)
                };
                if (crp.iv) {
                    result.iv = crp.iv.toString();
                }
                if (crp.salt) {
                    result.s = crp.salt.toString();
                }
                return JSON.stringify(result);
            },
            parse: function (output) {
                let parse = JSON.parse(output);
                let result = CryptoJS.lib.CipherParams.create({
                    ciphertext: CryptoJS.enc.Base64.parse(parse.ct)
                });
                if (parse.iv) {
                    result.iv = CryptoJS.enc.Hex.parse(parse.iv);
                }
                if (parse.s) {
                    result.salt = CryptoJS.enc.Hex.parse(parse.s);
                }
                return result;
            }
        };

        function _toBase64(payload) {
            let vBtoa = btoa(payload);
            vBtoa = vBtoa.replace("+", "-");
            vBtoa = vBtoa.replace("/", "_");
            vBtoa = vBtoa.replace("=", "");
            return vBtoa;
        }

        // 完全照抄Tampermonkey的_encode函数，但强制生成IV和salt
        function _encode(payload, options) {
            if (!payload) {
                return false;
            }

            // 强制生成salt和IV
            const salt = CryptoJS.lib.WordArray.random(64/8);
            const iv = CryptoJS.lib.WordArray.random(128/8);
            
            console.log('强制生成 salt:', salt.toString());
            console.log('强制生成 iv:', iv.toString());

            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(payload), options || SECRET_KEY, {
                iv: iv,
                salt: salt,
                format: formatJson
            });
            
            const result = encrypted.toString();
            console.log('加密结果:', result);
            
            return _toBase64(result).trim();
        }

        function testEncryption() {
            const results = document.getElementById('results');
            results.innerHTML = '<h3>测试结果:</h3>';
            
            const videoId = 'g_cU-DrUPGI';
            const url = `https://www.youtube.com/watch?v=${videoId}`;
            
            console.log('=== 开始加密测试 ===');
            
            // 测试多次加密，看是否生成不同结果
            for (let i = 0; i < 3; i++) {
                console.log(`\n--- URL加密测试 ${i+1} ---`);
                const urlEncrypted = _encode(url);
                console.log(`URL加密结果:`, urlEncrypted);
                
                console.log(`\n--- VideoID加密测试 ${i+1} ---`);
                const idEncrypted = _encode(videoId);
                console.log(`VideoID加密结果:`, idEncrypted);
                
                if (urlEncrypted && idEncrypted) {
                    try {
                        // 解码查看内容
                        const urlDecoded = atob(urlEncrypted.replace(/-/g, '+').replace(/_/g, '/') + '===='.substring(urlEncrypted.length % 4));
                        const urlParsed = JSON.parse(urlDecoded);
                        
                        const idDecoded = atob(idEncrypted.replace(/-/g, '+').replace(/_/g, '/') + '===='.substring(idEncrypted.length % 4));
                        const idParsed = JSON.parse(idDecoded);
                        
                        results.innerHTML += `
                            <div style="margin: 10px 0; padding: 10px; border: 1px solid ${urlParsed.iv && urlParsed.s ? '#0a0' : '#fa0'};">
                                <h4>第${i+1}次加密结果:</h4>
                                <h5>URL加密:</h5>
                                <p><strong>加密字符串:</strong> ${urlEncrypted}</p>
                                <p><strong>长度:</strong> ${urlEncrypted.length}</p>
                                <p><strong>包含字段:</strong> ${Object.keys(urlParsed).join(', ')}</p>
                                <p><strong>有IV:</strong> ${urlParsed.iv ? '✅' : '❌'}</p>
                                <p><strong>有Salt:</strong> ${urlParsed.s ? '✅' : '❌'}</p>
                                
                                <h5>VideoID加密:</h5>
                                <p><strong>加密字符串:</strong> ${idEncrypted}</p>
                                <p><strong>长度:</strong> ${idEncrypted.length}</p>
                                <p><strong>包含字段:</strong> ${Object.keys(idParsed).join(', ')}</p>
                                <p><strong>有IV:</strong> ${idParsed.iv ? '✅' : '❌'}</p>
                                <p><strong>有Salt:</strong> ${idParsed.s ? '✅' : '❌'}</p>
                            </div>
                        `;
                    } catch (e) {
                        results.innerHTML += `<p>解析失败: ${e.message}</p>`;
                    }
                } else {
                    results.innerHTML += `<p style="color: red;">第${i+1}次加密失败</p>`;
                }
            }
        }

        function testWorkingFormat() {
            const workingData = 'eyJjdCI6Im5wMU81NTlNQ2dGYTRGUGlPVXFnRnc9PSIsIml2IjoiZWI3NTU1NzZkY2UyODJjZDdjMjk2NzQ3NThkZGYwNTgiLCJzIjoiNzZjNGVlMDJkNzk4ZDJjYiJ9';
            
            const results = document.getElementById('results');
            results.innerHTML += '<h3>工作格式分析:</h3>';
            
            try {
                // 解码工作的格式
                const decoded = atob(workingData.replace(/-/g, '+').replace(/_/g, '/') + '===='.substring(workingData.length % 4));
                const parsed = JSON.parse(decoded);
                
                results.innerHTML += `
                    <div style="margin: 10px 0; padding: 10px; border: 1px solid #0a0;">
                        <h4>工作的加密格式:</h4>
                        <p><strong>加密字符串:</strong> ${workingData}</p>
                        <p><strong>长度:</strong> ${workingData.length}</p>
                        <p><strong>包含字段:</strong> ${Object.keys(parsed).join(', ')}</p>
                        <p><strong>详细内容:</strong> <pre>${JSON.stringify(parsed, null, 2)}</pre></p>
                        <p><strong>iv长度:</strong> ${parsed.iv ? parsed.iv.length : 'N/A'}</p>
                        <p><strong>s长度:</strong> ${parsed.s ? parsed.s.length : 'N/A'}</p>
                    </div>
                `;
                
                console.log('工作格式详情:', parsed);
            } catch (e) {
                results.innerHTML += `<p>解析工作格式失败: ${e.message}</p>`;
            }
        }
    </script>
</body>
</html> 