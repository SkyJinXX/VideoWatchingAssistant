<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加密功能测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-case {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔐 加密功能测试</h1>
        
        <div id="results"></div>
        
        <button onclick="runTests()">运行测试</button>
        <button onclick="decodeResult()">解码结果</button>
    </div>

    <script src="src/utils/crypto-js.min.js"></script>
    <script>
        const SECRET_KEY = "zthxw34cdp6wfyxmpad38v52t3hsz6c5";
        
        // 完整的加密逻辑
        const formatJson = {
            stringify: function (crp) {
                let result = {
                    ct: crp.ciphertext.toString(CryptoJS.enc.Base64)
                };
                if (crp.iv) {
                    result.iv = crp.iv.toString();
                }
                if (crp.salt) {
                    result.s = crp.salt.toString();
                }
                return JSON.stringify(result);
            },
            parse: function (output) {
                let parse = JSON.parse(output);
                let result = CryptoJS.lib.CipherParams.create({
                    ciphertext: CryptoJS.enc.Base64.parse(parse.ct)
                });
                if (parse.iv) {
                    result.iv = CryptoJS.enc.Hex.parse(parse.iv);
                }
                if (parse.s) {
                    result.salt = CryptoJS.enc.Hex.parse(parse.s);
                }
                return result;
            }
        };

        function _toBase64(payload) {
            let vBtoa = btoa(payload);
            vBtoa = vBtoa.replace("+", "-");
            vBtoa = vBtoa.replace("/", "_");
            vBtoa = vBtoa.replace("=", "");
            return vBtoa;
        }

        function _encode(payload) {
            if (!payload) {
                return false;
            }

            let result = CryptoJS.AES.encrypt(JSON.stringify(payload), SECRET_KEY, {
                format: formatJson
            }).toString();
            return _toBase64(result).trim();
        }

        function _generateData(videoId) {
            const url = `https://www.youtube.com/watch?v=${videoId}`;
            
            return {
                state: 99,
                url: url,
                urlEncrypt: _encode(url),
                source: 0,
                id: _encode(videoId),
                playlistId: null
            };
        }

        function runTests() {
            const testVideoIds = [
                'g_cU-DrUPGI',
                'dQw4w9WgXcQ', 
                'jNQXAC9IVRw',
                'M7lc1UVf-VE',
                ''  // 空值测试
            ];

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            testVideoIds.forEach(videoId => {
                const testCase = document.createElement('div');
                testCase.className = 'test-case';
                
                try {
                    const data = _generateData(videoId);
                    
                    testCase.innerHTML = `
                        <h3>视频ID: "${videoId}"</h3>
                        <div class="result">
                            URL: ${data.url}<br>
                            加密的videoId: ${data.id}<br>
                            加密的URL: ${data.urlEncrypt}<br>
                            完整API URL: https://get-info.downsub.com/${data.id}
                        </div>
                    `;
                } catch (error) {
                    testCase.innerHTML = `
                        <h3>视频ID: "${videoId}" (错误)</h3>
                        <div class="result" style="color: red;">
                            错误: ${error.message}
                        </div>
                    `;
                }
                
                resultsDiv.appendChild(testCase);
            });
        }

        function decodeResult() {
            const base64String = "eyJjdCI6IkltZGZZMVV0UkhKVlVFZEpJZz09In0";
            
            try {
                // 解码base64
                const decoded = atob(base64String);
                console.log('Base64解码结果:', decoded);
                
                // 尝试解析JSON
                const parsed = JSON.parse(decoded);
                console.log('JSON解析结果:', parsed);
                
                // 解码ct部分
                if (parsed.ct) {
                    const ctDecoded = atob(parsed.ct);
                    console.log('CT部分解码:', ctDecoded);
                }
                
                const resultDiv = document.createElement('div');
                resultDiv.className = 'test-case';
                resultDiv.innerHTML = `
                    <h3>解码 "${base64String}"</h3>
                    <div class="result">
                        Base64解码: ${decoded}<br>
                        JSON解析: ${JSON.stringify(parsed, null, 2)}<br>
                        ${parsed.ct ? `CT解码尝试: 二进制数据` : ''}
                    </div>
                `;
                
                document.getElementById('results').appendChild(resultDiv);
                
            } catch (error) {
                console.error('解码失败:', error);
                alert('解码失败: ' + error.message);
            }
        }

        // 页面加载时运行测试
        window.addEventListener('load', () => {
            setTimeout(runTests, 500);
        });
    </script>
</body>
</html> 