<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>字幕提取器调试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .debug {
            background: #e2e3e5;
            border: 1px solid #d6d8db;
            color: #383d41;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 字幕提取器调试工具</h1>
        
        <div class="input-group">
            <label for="videoId">YouTube 视频 ID:</label>
            <input type="text" id="videoId" placeholder="例如: g_cU-DrUPGI" value="g_cU-DrUPGI">
        </div>
        
        <button id="testEncryption">测试加密功能</button>
        <button id="testAPI">测试API请求</button>
        <button id="compareWithTM">对比Tampermonkey</button>
        
        <div id="result" class="result debug" style="display: none;"></div>
    </div>

    <!-- 引入依赖 -->
    <script src="src/utils/crypto-js.min.js"></script>
    <script>
        // 复制SubtitleExtractor类的核心功能用于测试
        class DebugSubtitleExtractor {
            constructor() {
                this.SECRET_KEY = "zthxw34cdp6wfyxmpad38v52t3hsz6c5";
                this.API = "https://get-info.downsub.com/";
                this.CryptoJS = window.CryptoJS;
            }

            get formatJson() {
                return {
                    stringify: (crp) => {
                        let result = {
                            ct: crp.ciphertext.toString(this.CryptoJS.enc.Base64)
                        };
                        if (crp.iv) {
                            result.iv = crp.iv.toString();
                        }
                        if (crp.salt) {
                            result.s = crp.salt.toString();
                        }
                        return JSON.stringify(result);
                    },
                    parse: (output) => {
                        let parse = JSON.parse(output);
                        let result = this.CryptoJS.lib.CipherParams.create({
                            ciphertext: this.CryptoJS.enc.Base64.parse(parse.ct)
                        });
                        if (parse.iv) {
                            result.iv = this.CryptoJS.enc.Hex.parse(parse.iv);
                        }
                        if (parse.s) {
                            result.salt = this.CryptoJS.enc.Hex.parse(parse.s);
                        }
                        return result;
                    }
                };
            }

            _toBase64(payload) {
                let vBtoa = btoa(payload);
                vBtoa = vBtoa.replace("+", "-");
                vBtoa = vBtoa.replace("/", "_");
                vBtoa = vBtoa.replace("=", "");
                return vBtoa;
            }

            _toBinary(base64) {
                let data = base64.replace("-", "+");
                data = data.replace("_", "/");
                const mod4 = data.length % 4;
                if (mod4) {
                    data += "====".substring(mod4);
                }
                return atob(data);
            }

            _encode(payload, options) {
                if (!payload) {
                    return false;
                }

                let result = this.CryptoJS.AES.encrypt(JSON.stringify(payload), options || this.SECRET_KEY, {
                    format: this.formatJson
                }).toString();
                return this._toBase64(result).trim();
            }

            _generateData(videoId) {
                const url = `https://www.youtube.com/watch?v=${videoId}`;
                let id = videoId;
                
                return {
                    state: 99,
                    url: url,
                    urlEncrypt: this._encode(url),
                    source: 0,
                    id: this._encode(id),
                    playlistId: null
                };
            }

            async testDirectAPI(videoId) {
                const data = this._generateData(videoId);
                const url = `${this.API}${data.id}`;
                
                const headers = {
                    "authority": "get-info.downsub.com",
                    "accept": "application/json, text/plain, */*",
                    "accept-language": "id-ID,id;q=0.9",
                    "origin": "https://downsub.com",
                    "priority": "u=1, i",
                    "referer": "https://downsub.com/",
                    "sec-ch-ua": '"Not(A:Brand";v="99", "Google Chrome";v="133", "Chromium";v="133"',
                    "sec-ch-ua-mobile": "?0",
                    "sec-ch-ua-platform": '"Windows"',
                    "sec-fetch-dest": "empty",
                    "sec-fetch-mode": "cors",
                    "sec-fetch-site": "same-site",
                    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36"
                };

                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: headers,
                        mode: 'cors'
                    });

                    return {
                        status: response.status,
                        statusText: response.statusText,
                        headers: Object.fromEntries(response.headers),
                        body: response.ok ? await response.json() : await response.text()
                    };
                } catch (error) {
                    return {
                        error: error.message
                    };
                }
            }
        }

        const extractor = new DebugSubtitleExtractor();
        const resultDiv = document.getElementById('result');

        function showResult(content, type = 'debug') {
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = typeof content === 'object' ? JSON.stringify(content, null, 2) : content;
            resultDiv.style.display = 'block';
        }

        document.getElementById('testEncryption').addEventListener('click', () => {
            const videoId = document.getElementById('videoId').value;
            if (!videoId) {
                showResult('请输入视频ID', 'error');
                return;
            }

            try {
                const data = extractor._generateData(videoId);
                const result = {
                    videoId: videoId,
                    generatedData: data,
                    apiUrl: extractor.API + data.id
                };
                showResult(result, 'success');
            } catch (error) {
                showResult('加密测试失败: ' + error.message, 'error');
            }
        });

        document.getElementById('testAPI').addEventListener('click', async () => {
            const videoId = document.getElementById('videoId').value;
            if (!videoId) {
                showResult('请输入视频ID', 'error');
                return;
            }

            const button = document.getElementById('testAPI');
            button.disabled = true;
            button.textContent = '测试中...';

            try {
                const result = await extractor.testDirectAPI(videoId);
                showResult(result, result.error ? 'error' : 'success');
            } catch (error) {
                showResult('API测试失败: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.textContent = '测试API请求';
            }
        });

        document.getElementById('compareWithTM').addEventListener('click', () => {
            showResult(`
对比结果:

1. 加密密钥: ${extractor.SECRET_KEY}
2. API地址: ${extractor.API}
3. 测试视频ID: ${document.getElementById('videoId').value}

Tampermonkey脚本和Chrome扩展使用相同的:
- 加密算法 (AES)
- 密钥
- API端点
- 数据生成逻辑

主要区别:
- Tampermonkey: 使用 GM_xmlhttpRequest (可绕过CORS)
- Chrome扩展: 使用 fetch() (受CORS限制)

建议检查:
1. 网络请求是否被拦截
2. Headers是否完全匹配
3. CORS策略是否允许跨域请求
            `, 'debug');
        });

        // 页面加载时显示说明
        window.addEventListener('load', () => {
            showResult('字幕提取器调试工具已加载。点击上方按钮开始测试。', 'debug');
        });
    </script>
</body>
</html> 